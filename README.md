# shop-project — Система мониторинга интернет-магазина

End-to-end локальная система генерации и обработки данных, имитирующая продакшн интернет-магазина.

## Архитектура
**Generator (Python)** → **RabbitMQ** → **Collector (Python)** → **ClickHouse** → **Grafana**

- Generator: генерирует поток событий (page_view → product_view → add_to_cart → checkout_start → payment_attempt → order_paid)
- RabbitMQ: очередь/буфер
- Collector: читает из очереди, батчит, валидирует и пишет в ClickHouse
- ClickHouse: хранение + аналитические запросы
- Grafana: дашборд

## Быстрый старт
```bash
docker compose up -d --build
```

## Какие данные генерируются

Проект генерирует **синтетический поток событий интернет-магазина** (event log) — как будто пользователи в реальном времени заходят на сайт/в приложение и совершают действия.

Одна строка в таблице = **одно событие (одно действие)** в конкретный момент времени.

### Типы событий (event_type)

- `page_view` — пользователь открыл страницу/зашёл в магазин (старт сессии)
- `product_view` — просмотр карточки товара
- `add_to_cart` — добавление товара в корзину
- `checkout_start` — начало оформления заказа
- `payment_attempt` — попытка оплаты (может быть успешной или с ошибкой)
- `order_created` — заказ создан (появляется `order_id`)
- `order_paid` — заказ оплачен
- `order_delivered` — заказ доставлен (успешное завершение)
- `order_cancelled` — заказ отменён (завершение с причиной)

### Основные поля событий

События записываются в `shop.events_raw` и содержат:

**Время**
- `event_time` — точное время события (UTC)
- `event_date` — дата события (для партиций)

**Идентификаторы**
- `event_id` — уникальный id события
- `user_id` — id пользователя
- `session_id` — id сессии (один «заход» пользователя)
- `order_id` — id заказа (для событий заказа; для остальных — нулевой UUID)

**Товар**
- `product_id` — id товара (для `product_view`, `add_to_cart`, заказных событий)
- `category` — категория товара
- `price` — цена товара
- `quantity` — количество (актуально для корзины/заказа)

**Контекст**
- `device` — `web / ios / android`
- `channel` — `organic / ads / email` (канал привлечения)
- `country` — страна

**Качество/ошибки**
- `status` — `ok / error` (в основном для `payment_attempt`)
- `error_code` — код причины (например `DECLINED`, `PROVIDER_5XX`, `PAYMENT_TIMEOUT`, либо причины отмены)
- `latency_ms` — синтетическая «задержка ответа приложения» в миллисекундах (для p95/p99 и мониторинга)

---

## Что получаем из этих данных (витрины/агрегации)

### 1) Журнал событий: `shop.events_raw`

Это основная «сырая» таблица для:
- временных рядов (сколько событий/минуту, пики)
- воронок (переходы между событиями)
- топов (категории/товары/каналы)
- качества (ошибки, latency)

### 2) Факты по заказам: `shop.orders_fact`

Из сырых событий автоматически собирается витрина **«одна строка = один заказ»**.

Витрина строится материализованным представлением (`mv_orders_fact`) и содержит:
- времена ключевых стадий заказа: `created_time`, `paid_time`, `delivered_time`, `cancelled_time`
- атрибуты заказа: `channel`, `device`, `country`
- итоговые показатели:  
  - `order_value` — стоимость заказа (сумма `price * quantity`)  
  - `items` — количество товаров (сумма `quantity`)
- статус оплаты/завершения: `payment_status` (`paid/cancelled/failed/unknown`)
- причина отмены (если есть): `cancel_reason`

Эта витрина нужна, чтобы быстро считать метрики типа:
- выручка, число заказов, средний чек (AOV)
- доля отмен/ошибок
- скорость выполнения заказов (время до оплаты/доставки)

### 3) Первый день активности пользователя: `shop.user_first_seen`

Автоматически вычисляется минимальная дата активности пользователя:
- `user_id`
- `first_date` — первый день, когда пользователь появился в событиях

Используется для когорт/retention (например, «повторная активность относительно первого дня/часа»).

---

## Про аномалии (как отражаются в данных)

Генератор может работать в разных сценариях (`SCENARIO`), которые **меняют распределения** и должны быть видны в метриках:

- `traffic_spike` — резко больше событий → растут графики трафика
- `bot_attack` — много просмотров без покупок → падает конверсия воронки
- `payment_incident` — больше ошибок оплаты → растёт доля `status=error` и `error_code`
- `slow_app` — увеличивается `latency_ms` → растут p95/p99 задержки


